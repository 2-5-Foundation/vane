import { decodeBlockStorageDiff } from '@acala-network/chopsticks-core';
import { create } from 'jsondiffpatch';
import _ from 'lodash';
const diffPatcher = create({
    array: {
        detectMove: false
    },
    textDiff: {
        minLength: Number.MAX_VALUE
    }
});
export const decodeStorageDiff = async (block, diff)=>{
    const [oldState, newState] = await decodeBlockStorageDiff(block, diff);
    const oldStateWithoutEvents = _.cloneDeep(oldState);
    if (oldStateWithoutEvents['system']?.['events']) {
        oldStateWithoutEvents['system']['events'] = [];
    }
    return {
        oldState,
        newState,
        delta: diffPatcher.diff(oldStateWithoutEvents, newState)
    };
};
